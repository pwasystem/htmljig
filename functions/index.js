const apiKey = process.env.GEMINIKEY;

const {onRequest} = require("firebase-functions/v2/https");
const logger = require("firebase-functions/logger");
const fs = require('fs');
const https = require('https');

const {
	GoogleGenerativeAI,
	HarmCategory,
	HarmBlockThreshold,
} = require("@google/generative-ai");

const genAI = new GoogleGenerativeAI(apiKey);

const model = genAI.getGenerativeModel({
	model: "gemini-1.5-flash",
});
const generationConfig = {
	temperature: 1,
	topP: 0.95,
	topK: 64,
	maxOutputTokens: 8192,
	responseMimeType: "text/plain",
};

//request
exports.htmljig = onRequest(async  (req, res) => {
	data = JSON.parse(req.body);
	logger.info({"status":"htmlJig Start!","data":data}, {structuredData: true});	
	let html = await getTemplate(data.template);
	let message = 'Aways return only a HTML code without explanaiton.\nUse the HTML template below '+(data.images!=''?'and this image list: '+data.images+' ;':'')+' to create a website for your company:\n'+data.title+', '+data.description+'.\nYou must create all the texts and find images relevant to the topic, create an hmtl and just provide the code.\n\n```html\n'+html+'\n```';
	let code = await getGemini(message);
	data.hash = hash(data.file)
	fs.writeFile(`../public/${data.hash}.html`, code.replace('´´´html','').replace('´´´',''), function (err) {
		if (err) throw err;
		logger.info({"status":`${data.hash}.html has created!`}, {structuredData: true});
	});
	res.send('{"title":"'+data.title+'","hash":"'+data.hash+'"}');
	res.end();
});

//gemini
async function getGemini(message) {
	const chatSession = model.startChat({
		generationConfig,
		history: [
      {
        role: "user",
        parts: [
          {text: "Aways return only a HTML code without explanaiton. Use the HTML template below to create a website for your company:\nPWA System, developing applications and websites using AI.\nYou must create all the texts and find images relevant to the topic, create an hmtl and just provide the code.\n\n```html\n<!DOCTYPE html>\n<html>\n<head>\n<title>W3.CSS Template</title>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<link rel=\"stylesheet\" href=\"https://www.w3schools.com/w3css/4/w3.css\">\n<link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Inconsolata\">\n<style>\nbody, html {\n  height: 100%;\n  font-family: \"Inconsolata\", sans-serif;\n}\n\n.bgimg {\n  background-position: center;\n  background-size: cover;\n  background-image: url(\"/w3images/coffeehouse.jpg\");\n  min-height: 75%;\n}\n\n.menu {\n  display: none;\n}\n</style>\n</head>\n<body>\n\n<!-- Links (sit on top) -->\n<div class=\"w3-top\">\n  <div class=\"w3-row w3-padding w3-black\">\n    <div class=\"w3-col s3\">\n      <a href=\"#\" class=\"w3-button w3-block w3-black\">HOME</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#about\" class=\"w3-button w3-block w3-black\">ABOUT</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#menu\" class=\"w3-button w3-block w3-black\">MENU</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#where\" class=\"w3-button w3-block w3-black\">WHERE</a>\n    </div>\n  </div>\n</div>\n\n<!-- Header with image -->\n<header class=\"bgimg w3-display-container w3-grayscale-min\" id=\"home\">\n  <div class=\"w3-display-bottomleft w3-center w3-padding-large w3-hide-small\">\n    <span class=\"w3-tag\">Open from 6am to 5pm</span>\n  </div>\n  <div class=\"w3-display-middle w3-center\">\n    <span class=\"w3-text-white\" style=\"font-size:90px\">the<br>Cafe</span>\n  </div>\n  <div class=\"w3-display-bottomright w3-center w3-padding-large\">\n    <span class=\"w3-text-white\">15 Adr street, 5015</span>\n  </div>\n</header>\n\n<!-- Add a background color and large text to the whole page -->\n<div class=\"w3-sand w3-grayscale w3-large\">\n\n<!-- About Container -->\n<div class=\"w3-container\" id=\"about\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n    <h5 class=\"w3-center w3-padding-64\"><span class=\"w3-tag w3-wide\">ABOUT THE CAFE</span></h5>\n    <p>The Cafe was founded in blabla by Mr. Smith in lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat.</p>\n    <p>In addition to our full espresso and brew bar menu, we serve fresh made-to-order breakfast and lunch sandwiches, as well as a selection of sides and salads and other good stuff.</p>\n    <div class=\"w3-panel w3-leftbar w3-light-grey\">\n      <p><i>\"Use products from nature for what it's worth - but never too early, nor too late.\" Fresh is the new sweet.</i></p>\n      <p>Chef, Coffeeist and Owner: Liam Brown</p>\n    </div>\n    <img src=\"/w3images/coffeeshop.jpg\" style=\"width:100%;max-width:1000px\" class=\"w3-margin-top\">\n    <p><strong>Opening hours:</strong> everyday from 6am to 5pm.</p>\n    <p><strong>Address:</strong> 15 Adr street, 5015, NY</p>\n  </div>\n</div>\n\n<!-- Menu Container -->\n<div class=\"w3-container\" id=\"menu\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n \n    <h5 class=\"w3-center w3-padding-48\"><span class=\"w3-tag w3-wide\">THE MENU</span></h5>\n  \n    <div class=\"w3-row w3-center w3-card w3-padding\">\n      <a href=\"javascript:void(0)\" onclick=\"openMenu(event, 'Eat');\" id=\"myLink\">\n        <div class=\"w3-col s6 tablink\">Eat</div>\n      </a>\n      <a href=\"javascript:void(0)\" onclick=\"openMenu(event, 'Drinks');\">\n        <div class=\"w3-col s6 tablink\">Drink</div>\n      </a>\n    </div>\n\n    <div id=\"Eat\" class=\"w3-container menu w3-padding-48 w3-card\">\n      <h5>Bread Basket</h5>\n      <p class=\"w3-text-grey\">Assortment of fresh baked fruit breads and muffins 5.50</p><br>\n    \n      <h5>Honey Almond Granola with Fruits</h5>\n      <p class=\"w3-text-grey\">Natural cereal of honey toasted oats, raisins, almonds and dates 7.00</p><br>\n    \n      <h5>Belgian Waffle</h5>\n      <p class=\"w3-text-grey\">Vanilla flavored batter with malted flour 7.50</p><br>\n    \n      <h5>Scrambled eggs</h5>\n      <p class=\"w3-text-grey\">Scrambled eggs, roasted red pepper and garlic, with green onions 7.50</p><br>\n    \n      <h5>Blueberry Pancakes</h5>\n      <p class=\"w3-text-grey\">With syrup, butter and lots of berries 8.50</p>\n    </div>\n\n    <div id=\"Drinks\" class=\"w3-container menu w3-padding-48 w3-card\">\n      <h5>Coffee</h5>\n      <p class=\"w3-text-grey\">Regular coffee 2.50</p><br>\n    \n      <h5>Chocolato</h5>\n      <p class=\"w3-text-grey\">Chocolate espresso with milk 4.50</p><br>\n    \n      <h5>Corretto</h5>\n      <p class=\"w3-text-grey\">Whiskey and coffee 5.00</p><br>\n    \n      <h5>Iced tea</h5>\n      <p class=\"w3-text-grey\">Hot tea, except not hot 3.00</p><br>\n    \n      <h5>Soda</h5>\n      <p class=\"w3-text-grey\">Coke, Sprite, Fanta, etc. 2.50</p>\n    </div>  \n    <img src=\"/w3images/coffeehouse2.jpg\" style=\"width:100%;max-width:1000px;margin-top:32px;\">\n  </div>\n</div>\n\n<!-- Contact/Area Container -->\n<div class=\"w3-container\" id=\"where\" style=\"padding-bottom:32px;\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n    <h5 class=\"w3-center w3-padding-48\"><span class=\"w3-tag w3-wide\">WHERE TO FIND US</span></h5>\n    <p>Find us at some address at some place.</p>\n    <img src=\"/w3images/map.jpg\" class=\"w3-image\" style=\"width:100%\">\n    <p><span class=\"w3-tag\">FYI!</span> We offer full-service catering for any event, large or small. We understand your needs and we will cater the food to satisfy the biggerst criteria of them all, both look and taste.</p>\n    <p><strong>Reserve</strong> a table, ask for today's special or just send us a message:</p>\n    <form action=\"/action_page.php\" target=\"_blank\">\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"text\" placeholder=\"Name\" required name=\"Name\"></p>\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"number\" placeholder=\"How many people\" required name=\"People\"></p>\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"datetime-local\" placeholder=\"Date and time\" required name=\"date\" value=\"2020-11-16T20:00\"></p>\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"text\" placeholder=\"Message \\ Special requirements\" required name=\"Message\"></p>\n      <p><button class=\"w3-button w3-black\" type=\"submit\">SEND MESSAGE</button></p>\n    </form>\n  </div>\n</div>\n\n<!-- End page content -->\n</div>\n\n<!-- Footer -->\n<footer class=\"w3-center w3-light-grey w3-padding-48 w3-large\">\n  <p>Powered by <a href=\"https://www.w3schools.com/w3css/default.asp\" title=\"W3.CSS\" target=\"_blank\" class=\"w3-hover-text-green\">w3.css</a></p>\n</footer>\n\n<script>\n// Tabbed Menu\nfunction openMenu(evt, menuName) {\n  var i, x, tablinks;\n  x = document.getElementsByClassName(\"menu\");\n  for (i = 0; i < x.length; i++) {\n    x[i].style.display = \"none\";\n  }\n  tablinks = document.getElementsByClassName(\"tablink\");\n  for (i = 0; i < x.length; i++) {\n    tablinks[i].className = tablinks[i].className.replace(\" w3-dark-grey\", \"\");\n  }\n  document.getElementById(menuName).style.display = \"block\";\n  evt.currentTarget.firstElementChild.className += \" w3-dark-grey\";\n}\ndocument.getElementById(\"myLink\").click();\n</script>\n\n</body>\n</html>\n```"},
        ],
      },
      {
        role: "model",
        parts: [
          {text: "<!DOCTYPE html>\n<html>\n<head>\n<title>PWA System - AI-Powered Web & App Development</title>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n<link rel=\"stylesheet\" href=\"https://www.w3schools.com/w3css/4/w3.css\">\n<link rel=\"stylesheet\" href=\"https://fonts.googleapis.com/css?family=Inconsolata\">\n<style>\nbody, html {\n  height: 100%;\n  font-family: \"Inconsolata\", sans-serif;\n}\n\n.bgimg {\n  background-position: center;\n  background-size: cover;\n  background-image: url(\"https://plus.unsplash.com/premium_photo-1664041273166-58f5fdf2e6d3?q=80&w=1400&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\");\n  min-height: 75%;\n}\n\n.menu {\n  display: none;\n}\n</style>\n</head>\n<body>\n\n<!-- Links (sit on top) -->\n<div class=\"w3-top\">\n  <div class=\"w3-row w3-padding w3-black\">\n    <div class=\"w3-col s3\">\n      <a href=\"#\" class=\"w3-button w3-block w3-black\">HOME</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#about\" class=\"w3-button w3-block w3-black\">ABOUT</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#services\" class=\"w3-button w3-block w3-black\">SERVICES</a>\n    </div>\n    <div class=\"w3-col s3\">\n      <a href=\"#contact\" class=\"w3-button w3-block w3-black\">CONTACT</a>\n    </div>\n  </div>\n</div>\n\n<!-- Header with image -->\n<header class=\"bgimg w3-display-container w3-grayscale-min\" id=\"home\">\n  <div class=\"w3-display-middle w3-center\">\n    <span class=\"w3-text-white\" style=\"font-size:90px\">PWA<br>System</span>\n  </div>\n  <div class=\"w3-display-bottomleft w3-padding-large w3-hide-small\">\n    <span class=\"w3-tag w3-text-white\">AI-Powered Web & App Development</span>\n  </div>\n</header>\n\n<!-- Add a background color and large text to the whole page -->\n<div class=\"w3-sand w3-grayscale w3-large\">\n\n<!-- About Container -->\n<div class=\"w3-container\" id=\"about\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n    <h5 class=\"w3-center w3-padding-64\"><span class=\"w3-tag w3-wide\">ABOUT US</span></h5>\n    <p>PWA System is a leading provider of AI-powered web and mobile application development solutions. We leverage the power of artificial intelligence to create innovative, user-friendly, and high-performing applications that drive business success.</p>\n    <p>Our team of expert developers, designers, and AI specialists combines cutting-edge technology with creative thinking to deliver exceptional results. We are passionate about using AI to enhance the user experience and streamline business processes.</p>\n    <img src=\"https://images.unsplash.com/photo-1531746790731-6c087fecd65a?q=80&w=1406&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\" style=\"width:100%;max-width:1000px\" class=\"w3-margin-top\">\n  </div>\n</div>\n\n<!-- Services Container -->\n<div class=\"w3-container\" id=\"services\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n    <h5 class=\"w3-center w3-padding-48\"><span class=\"w3-tag w3-wide\">OUR SERVICES</span></h5>\n    <div class=\"w3-row w3-center w3-card w3-padding\">\n      <a href=\"javascript:void(0)\" onclick=\"openMenu(event, 'webdev');\" id=\"myLink\">\n        <div class=\"w3-col s6 tablink\">Web Development</div>\n      </a>\n      <a href=\"javascript:void(0)\" onclick=\"openMenu(event, 'appdev');\">\n        <div class=\"w3-col s6 tablink\">Mobile App Development</div>\n      </a>\n    </div>\n\n    <div id=\"webdev\" class=\"w3-container menu w3-padding-48 w3-card\">\n      <h5>AI-Powered Websites</h5>\n      <p class=\"w3-text-grey\">We build intelligent websites that learn from user interactions and provide personalized experiences. From responsive designs to advanced functionalities, we deliver websites that drive engagement and conversions.</p><br>\n    \n      <h5>E-commerce Solutions</h5>\n      <p class=\"w3-text-grey\">We create seamless e-commerce platforms powered by AI. Our solutions enable intelligent product recommendations, personalized shopping experiences, and optimized checkout processes.</p><br>\n    </div>\n\n    <div id=\"appdev\" class=\"w3-container menu w3-padding-48 w3-card\">\n      <h5>Custom Mobile Apps</h5>\n      <p class=\"w3-text-grey\">We build native and cross-platform mobile apps using AI to deliver engaging and user-friendly experiences. We specialize in developing apps that leverage AI capabilities like machine learning, natural language processing, and computer vision.</p><br>\n    \n      <h5>AI-Powered Chatbots</h5>\n      <p class=\"w3-text-grey\">We develop intelligent chatbots that provide 24/7 customer support, automate tasks, and enhance user engagement. Our chatbots are trained on massive datasets to provide accurate and personalized responses.</p>\n    </div>  \n    <img src=\"https://plus.unsplash.com/premium_photo-1663023612721-e588768ef403?q=80&w=1471&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D\" style=\"width:100%;max-width:1000px;margin-top:32px;\">\n  </div>\n</div>\n\n<!-- Contact Container -->\n<div class=\"w3-container\" id=\"contact\" style=\"padding-bottom:32px;\">\n  <div class=\"w3-content\" style=\"max-width:700px\">\n    <h5 class=\"w3-center w3-padding-48\"><span class=\"w3-tag w3-wide\">CONTACT US</span></h5>\n    <p>Let's discuss your project and how AI can empower your business.</p>\n    <form action=\"/action_page.php\" target=\"_blank\">\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"text\" placeholder=\"Name\" required name=\"Name\"></p>\n      <p><input class=\"w3-input w3-padding-16 w3-border\" type=\"email\" placeholder=\"Email\" required name=\"Email\"></p>\n      <p><textarea class=\"w3-input w3-padding-16 w3-border\" type=\"text\" placeholder=\"Message\" required name=\"Message\"></textarea></p>\n      <p><button class=\"w3-button w3-black\" type=\"submit\">SEND MESSAGE</button></p>\n    </form>\n  </div>\n</div>\n\n<!-- End page content -->\n</div>\n\n<!-- Footer -->\n<footer class=\"w3-center w3-light-grey w3-padding-48 w3-large\">\n  <p>Powered by <a href=\"https://htmljig.web.app\" title=\"HTML Jig\" target=\"_blank\" class=\"w3-hover-text-green\">HTML Jig</a></p>\n</footer>\n\n<script>\n// Tabbed Menu\nfunction openMenu(evt, menuName) {\n  var i, x, tablinks;\n  x = document.getElementsByClassName(\"menu\");\n  for (i = 0; i < x.length; i++) {\n    x[i].style.display = \"none\";\n  }\n  tablinks = document.getElementsByClassName(\"tablink\");\n  for (i = 0; i < x.length; i++) {\n    tablinks[i].className = tablinks[i].className.replace(\" w3-dark-grey\", \"\");\n  }\n  document.getElementById(menuName).style.display = \"block\";\n  evt.currentTarget.firstElementChild.className += \" w3-dark-grey\";\n}\ndocument.getElementById(\"myLink\").click();\n</script>\n\n</body>\n</html>"},
        ],
      },
    ]
     
	});
	const result = await chatSession.sendMessage(message);
	return result.response.text();
}

//get template source
async function getTemplate(template){
	return new Promise((resolve, reject) => {
		https.get(`https://www.w3schools.com/w3css/tryw3css_templates_${template}.htm`,res => {	
			let html = '' ;
			res.on('data', d => html += d);
			res.on('end', () => resolve(html));	
		}).on('error',e => reject(e));
	});
}

//normalize data
function normalize(data){
	return data.replace(/\r\n/g,"\\\\n").replace(/\t/g,"\\\\t");
}

//hash
function hash(word){
	return word.normalize(`NFD`).replace(/[\u0300-\u036f]/g,``).replace(/[^\w\s]/gi,``).replace(/\s/g,`-`).replace(/--/g,`-`).toLowerCase();
}